<!DOCTYPE html>

<html lang="uz">

<head>

  <meta charset="UTF-8">

  <title>Offline Taksometr (GPS)</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

 <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

   body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #0f0;
  min-height: 100vh;
  overflow-y: auto;   /* ğŸ”¥ BRAUZER SCROLL */
}


.app {
  position: relative;
  width: 100%;
  max-width: 420px;
  min-height: 100vh;     /* ğŸ”¥ height emas */
  margin: 0 auto;
  background: #000;
}



  .box {

      background: transparent;   /* TOâ€˜LIQ SHAFFOF */

      padding: 30px;

      border-radius: 16px;

      width: 100%;

      max-width: 420px;

      text-align: center;

      box-shadow: 0 0 25px #0f0;
      
      position: relative;

      z-index: 10;
 
    }


    h2 { font-size: 2rem; margin-bottom: 20px; }

    .row { margin: 12px 0; font-size: 1.2rem; }

    .price { font-size: 2.5rem; margin: 20px 0; }

    button {

      width: 100%;

      padding: 14px;

      margin-top: 10px;

      font-size: 1.2rem;

      border: none;

      border-radius: 10px;

      cursor: pointer;

      background: #0f0;

      color: #000;

    }

     .status {
  margin-bottom: 10px;
  padding: 6px;
  border-radius: 8px;
  font-weight: bold;
  font-size: 1rem;
}

.online {
  background: #0f0;
  color: #000;
}

.offline {
  background: #f00;
  color: #fff;
}

#goOnlineBtn {
  background: #0f0;
  color: #000;
}

#goOfflineBtn {
  background: #f00;
  color: #fff;
}

#map {
  position: absolute;
  inset: 0;
  z-index: 1;
}



#mapLoading {
  color: #0f0;
  font-size: 1rem;
  margin-top: 8px;
}
//ROL TANLASH DIZAYNI BOSHLANDI
#roleSelect {
  text-align: center;
}

#roleSelect button {
  margin: 8px 0;
  font-size: 1.1rem;
}
//MODAL OYNASI DIZAYNI BOSHLANDI
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;          /* ğŸ”´ DEFAULT YOPIQ */
  align-items: center;
  justify-content: center;
  z-index: 999;
}


.modal-box {
  background: #000;
  border: 2px solid #0f0;
  border-radius: 16px;
  padding: 20px;
  width: 90%;
  max-width: 320px;
  text-align: center;
  box-shadow: 0 0 25px #0f0;
}

.modal-box h3 {
  margin-bottom: 15px;
}

.modal-box button {
  margin-top: 15px;
  background: #0f0;
  color: #000;
  border-radius: 10px;
}

/* BOX YASHIRILGAN HOLAT */
.box.hidden {
  display: none;
}

/* 3 mm MINI TUGMA */
#miniHandle {
  position: absolute;          /* ğŸ”¥ APP ICHIDA */
  bottom: 8px;
  right: 8px;
  width: 18px;                 /* ~3 mm */
  height: 18px;
  border-radius: 50%;
  background: #0f0;
  color: #000;
  font-size: 12px;
  display: none;               /* default yopiq */
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 50;
  box-shadow: 0 0 10px #0f0;
}

/* ğŸ”„ LOADER */
.loader {
  width: 32px;
  height: 32px;
  border: 4px solid #0f0;
  border-top: 4px solid transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 15px auto;
  display: none;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* tugma yuklanayotganda */
button.loading {
  opacity: 0.6;
  pointer-events: none;
}

</style>

<script src="https://api-maps.yandex.ru/2.1/?apikey=d4f5509b-184b-4353-a9aa-45655cba59d9&lang=uz_UZ"></script>
<link rel="icon" href="data:,">


</head>

<body>




<div class="app">

<div id="map"></div>
  
    <div class="box">
    
    <h2>ğŸš•JAXOTAXI(GPS)</h2>
  
 <div id="roleSelect">
     <h3>Kim sifatida kirasiz?</h3>

      <button onclick="setRole('driver')">ğŸš• Haydovchi</button>
      <button onclick="setRole('passenger')">ğŸ§ Yoâ€˜lovchi</button>
      <button onclick="setRole('admin')">ğŸ›  Admin</button>
 </div>

<!-- AUTH (LOGIN / REGISTER) -->
<div id="authUI" style="display:none">
  <h3 id="authTitle">Hisobga kirish</h3>

  <input id="phone" placeholder="ğŸ“± Telefon raqam" style="width:100%;padding:10px;margin:6px 0;border-radius:8px;">
  <input id="password" type="password" placeholder="ğŸ”’ Parol" style="width:100%;padding:10px;margin:6px 0;border-radius:8px;">

  <button onclick="login()">ğŸ”‘ Kirish</button>
  <button onclick="register()">ğŸ“ Roâ€˜yxatdan oâ€˜tish</button>
  <div id="authLoader" class="loader"></div>
  <button class="backBtn" onclick="backToRoles()">â¬… Orqaga</button>
</div>

 <!-- XAYDOVCHI INTERFEYSI BOSHLANDI -->

           <div id="driverUI" style="display:none">
                        
                <div id="netStatus" class="status offline">ğŸ”´ Offline</div>

               

                <div id="mapLoading">ğŸ—º Xarita yuklanmoqda...</div>

               

                <div class="row">
                <button id="goOnlineBtn" onclick="goOnline()">ğŸŸ¢ Linyaga chiqish</button>
                <button id="goOfflineBtn" onclick="goOffline()" style="display:none">
                ğŸ”´ Linyadan chiqish
                </button>
                </div>
				 <div id="orderBox"
     style="display:none;
            margin-top:15px;
            padding:12px;
            border:2px solid #0f0;
            border-radius:12px;
            background:#000;
            z-index:20;
            position:relative;">
  <h3>ğŸ“¦ Buyurtma</h3>

  <p>ğŸ“ Yoâ€˜lovchi joylashuvi:</p>
  <p id="orderLocation"></p>

  <!-- SAFAR MA'LUMOTLARI -->
  <div id="tripPanel" style="display:none">

    <div class="row">â± Vaqt: <span id="time">00:00</span></div>
    <div class="row">ğŸ“ Masofa: <span id="distance">0.00</span> km</div>
    <div class="price">ğŸ’° <span id="price">3000</span> soâ€˜m</div>

    <button id="tripBtn" onclick="toggleTrip()">â–¶ Start</button>
    <button onclick="endTrip()">ğŸ Safarni yakunlash</button>

  </div>

  <!-- FAQAT BUYURTMA QABUL QILISH -->
  <button id="acceptBtn" onclick="acceptOrder()">âœ… Buyurtmani qabul qilish</button>

                     

                 </div>


               

<!-- SAFAR YAKUNI MODAL -->
<div id="endTripModal" class="modal" style="display:none">
  <div class="modal-box">
    <h3>ğŸ Safar yakunlandi</h3>

    <p>â± Vaqt: <span id="mTime"></span></p>
    <p>ğŸ“ Masofa: <span id="mDistance"></span> km</p>
    <p>ğŸ’° Narx: <span id="mPrice"></span> soâ€˜m</p>

    <button onclick="closeEndTripModal()">Yopish</button>
  </div>
</div>

<button onclick="hideBox()">â¬‡ Yashirish</button>

<button class="backBtn" onclick="goBack()">â¬… Orqaga</button>

            </div>
            <!-- XAYDOVCHI INTERFEYSI  TUGADI -->


<!-- yoiOVCHI INTERFEYSI  boshlandi -->

<div id="passengerUI" style="display:none">
  <h3>ğŸ§ Yoâ€˜lovchi paneli</h3>

  <div class="row">ğŸ“ Sizning joylashuvingiz</div>
  <div id="pMap" style="height:300px;border-radius:12px;"></div>

  <hr style="margin:15px 0;border-color:#0f0">
  
 <button id="orderBtn" onclick="orderTaxi()">
  ğŸš• Buyurtma berish
</button>

  <div id="tripInfo">
    <p>ğŸš• Safar kutilmoqda...</p>
  </div>
  <button class="backBtn" onclick="goBack()">â¬… Orqaga</button>
  
 

</div>

<!-- yoiOVCHI INTERFEYSI  tugadi -->

                        

                         <div id="adminUI" style="display:none">
                         <h3>ğŸ›  Admin paneli</h3>
                         <p>Haydovchilar va buyurtmalar</p>
						 <button class="backBtn" onclick="goBack()">â¬… Orqaga</button>

                         </div>




  

 

  

    </div>
	<div id="miniHandle" onclick="restoreBox()">â¬†</div>


 </div>

<script>
 // ğŸ“Œ Telefon va kompyuter uchun IP ni aniqlash
const API_URL =
  location.hostname === "localhost"
    ? "http://localhost:3000"
    : "https://oli-mtaxi-backend.onrender.com";

  let routeDrawn = false;

  let useManualLocation = false;

  let tripActive = false;

  let wakeLock = null;
  
  let passengerMapWatcher = null;
  
  let locationLocked = false; // ğŸ”“ boshida ochiq


  async function enableWakeLock() {

    try {

      wakeLock = await navigator.wakeLock.request('screen');

      console.log("Ekran oâ€˜chmaydi");

    } catch (err) {

      console.log("WakeLock xato:", err);

    }

  }

function toggleTrip() {
  if (!tripActive) {
    // START
    tripActive = true;
    startTrip();

    const btn = document.getElementById("tripBtn");
    btn.innerText = "â¹ Stop";
    btn.style.background = "#f00";
    btn.style.color = "#fff";

  } else {
    // STOP
    tripActive = false;
    stopTrip();

    const btn = document.getElementById("tripBtn");
    btn.innerText = "â–¶ Start";
    btn.style.background = "#0f0";
    btn.style.color = "#000";
  }
 

}


function disableWakeLock() {

    if (wakeLock) {

      wakeLock.release();

      wakeLock = null;

    }

  }

  let seconds = 0;

  let interval = null;

  let watchId = null;

  let lastPosition = null;

  let totalDistance = 0;

  const startPrice = 3000;

  const pricePerMinute = 300;

  const pricePerKm = 3000;

 function startTrip() {
  if (interval) return;

  // ğŸ”¥ SAFAR BOSHLANDI â€” BACKENDGA
  fetch(API_URL + "/api/trip/start", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      status: "started",
      time: "00:00",
      distance: 0,
      price: startPrice
    })
  });

  interval = setInterval(() => {
    seconds++;
    calculate();
    syncTrip(); // ğŸ”¥ LIVE YUBORISH
  }, 1000);
}

function stopTrip() {
  clearInterval(interval);
  interval = null;
}


  function reset() {

     stopTrip();

    seconds = 0;

    totalDistance = 0;

    lastPosition = null;

    document.getElementById("time").innerText = "00:00";

    document.getElementById("distance").innerText = "0.00";

    document.getElementById("price").innerText = startPrice;

  }

  function onPosition(position) {

    const { latitude, longitude } = position.coords;

    if (lastPosition) {

      const d = haversine(

        lastPosition.lat,

        lastPosition.lng,

        latitude,

        longitude

      );

      // juda kichik siljishni hisoblamaymizZ (GPS shovqin)

      if (d > 0.005 && tripActive) { // 5 metr  && tripActive DEGANI START AKTIVMI 

        totalDistance += d;

        document.getElementById("distance").innerText =

          totalDistance.toFixed(2);

        calculate();

      }

    }

    lastPosition = { lat: latitude, lng: longitude };

if (!yMap) {
  initMap(latitude, longitude);
} else if (driverPlacemark) {
  driverPlacemark.geometry.setCoordinates([latitude, longitude]);
  yMap.setCenter([latitude, longitude], 16, { duration: 300 });
}

fetch(API_URL + "/api/driver/location", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    lat: latitude,
    lng: longitude,
	driverId: driverId // ğŸ”¥ SHART  
  })
});


  } //funksiya tugashdi

  function onError(err) {

    console.log("GPS xato:", err.message);

  }

  function calculate() {

    let minutes = Math.floor(seconds / 60);

    let sec = seconds % 60;

    let timePrice = (seconds / 60) * pricePerMinute;

    let distancePrice = totalDistance * pricePerKm;

    let total = startPrice + timePrice + distancePrice;

    document.getElementById("time").innerText =

      `${String(minutes).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;

    document.getElementById("price").innerText =

      Math.floor(total);

  }

  // Haversine formulasi (km)

  function haversine(lat1, lon1, lat2, lon2) {

    const R = 6371;

    const dLat = (lat2 - lat1) * Math.PI / 180;

    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =

      Math.sin(dLat / 2) * Math.sin(dLat / 2) +

      Math.cos(lat1 * Math.PI / 180) *

      Math.cos(lat2 * Math.PI / 180) *

      Math.sin(dLon / 2) * Math.sin(dLon / 2);

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  }

function updateNetworkStatus() {
  const statusEl = document.getElementById("netStatus");

  if (navigator.onLine) {
    statusEl.innerText = "ğŸŸ¢ Online";
    statusEl.className = "status online";
  } else {
    statusEl.innerText = "ğŸ”´ Offline";
    statusEl.className = "status offline";
  }
}

// dastur ochilganda
updateNetworkStatus();

// internet oâ€˜zgarganda
window.addEventListener("online", updateNetworkStatus);
window.addEventListener("offline", updateNetworkStatus);

let isOnline = false;

function enableTracking() {
  if (!navigator.geolocation) {
    alert("GPS qoâ€˜llab-quvvatlanmaydi");
    return;
  }

  watchId = navigator.geolocation.watchPosition(
    onPosition,
    onError,
    {
      enableHighAccuracy: true,
      maximumAge: 1000,
      timeout: 5000
    }
  );
}//Funksiya tugadi


function goOnline() {
  if (!navigator.onLine) {
    alert("Internet yoâ€˜q. Linyaga chiqib boâ€˜lmaydi.");
    return;
  }

  isOnline = true;

  document.getElementById("goOnlineBtn").style.display = "none";
  document.getElementById("goOfflineBtn").style.display = "block";

  enableWakeLock();
  enableTracking();   // ğŸ‘ˆ JOYLASHUV SHU YERDA
  watchOrdersForDriver(); // ğŸ“¦ BUYURTMANI KUZATISH
  console.log("Haydovchi LINYAGA CHIQDI");
}

function goOffline() {
  isOnline = false;

  document.getElementById("goOnlineBtn").style.display = "block";
  document.getElementById("goOfflineBtn").style.display = "none";

   stopTrip();             // hisoblash toâ€˜xtaydi
  disableWakeLock();

  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }

if (orderWatcher) {
  clearInterval(orderWatcher);
  orderWatcher = null;
}

document.getElementById("orderBox").style.display = "none";

  console.log("Haydovchi LINYADAN CHIQDI");
}


let yMap;
let driverPlacemark;
let route = null;

function initMap(lat, lng) {
  ymaps.ready(() => {
    yMap = new ymaps.Map("map", {
      center: [lat, lng],
      zoom: 16,
      controls: []
    });

    driverPlacemark = new ymaps.Placemark(
      [lat, lng],
      { balloonContent: "ğŸš• Siz shu yerdasiz" },
      { preset: "islands#greenDotIcon" }
    );

    yMap.geoObjects.add(driverPlacemark);
  });
document.getElementById("mapLoading")?.remove();

setTimeout(() => {
  yMap.container.fitToViewport();
}, 300);

}

let role = null;

function setRole(selectedRole) {
  role = selectedRole;

  document.getElementById("roleSelect").style.display = "none";
  document.getElementById("authUI").style.display = "block";

  document.getElementById("authTitle").innerText =
    role === "driver" ? "ğŸš• Haydovchi kirishi" :
    role === "passenger" ? "ğŸ§ Yoâ€˜lovchi kirishi" :
    "ğŸ›  Admin kirishi";

  console.log("Rol tanlandi:", role);
}


function endTrip() {
  if (!tripActive) {
    alert("Safar hali boshlanmagan");
    return;
  }

  tripActive = false;
  stopTrip();

  // Safarni backend ga yuboramiz
  // âœ… TOâ€˜Gâ€˜RISI
fetch(API_URL + "/api/trip", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    role: role,
    time: document.getElementById("time").innerText,
    distance: totalDistance.toFixed(2),
    price: document.getElementById("price").innerText
  })
})

  .then(res => res.json())
  .then(data => console.log("Backend javobi:", data))
  .catch(err => console.log("Xato backendga yuborishda:", err));

  const btn = document.getElementById("tripBtn");
  btn.innerText = "â–¶ Start";
  btn.style.background = "#0f0";
  btn.style.color = "#000";

  openEndTripModal();
  
  document.getElementById("tripPanel").style.display = "none";
  document.getElementById("orderBox").style.display = "none";
  document.getElementById("acceptBtn").style.display = "block";

  reset();
  if (route) {
  yMap.geoObjects.remove(route);
  route = null;
}

routeDrawn = false;

if (route) {
  yMap.geoObjects.remove(route);
  route = null;
}

}

//MODAL OYNASI OCHISH Funksiya BOSHLANDI
function openEndTripModal() {
  document.getElementById("mTime").innerText =
    document.getElementById("time").innerText;

  document.getElementById("mDistance").innerText =
    totalDistance.toFixed(2);

  document.getElementById("mPrice").innerText =
    document.getElementById("price").innerText;

  document.getElementById("endTripModal").style.display = "flex";
}
//MODAL OYNASI Yopish Funksiya BOSHLANDI
function closeEndTripModal() {
  document.getElementById("endTripModal").style.display = "none";
}

function goBack() {
  document.getElementById("driverUI").style.display = "none";
  document.getElementById("passengerUI").style.display = "none";
  document.getElementById("adminUI").style.display = "none";

  document.getElementById("roleSelect").style.display = "block";
  document.getElementById("endTripModal").style.display = "none";

  // ğŸ”¥ YOâ€˜LOVCHI TOZALASH
  if (tripWatchInterval) {
    clearInterval(tripWatchInterval);
    tripWatchInterval = null;
  }

  tripWatcherStarted = false;

  console.log("Orqaga qaytildi (clean)");
}

let driverId = null;	
async function login() {
  showAuthLoader();

  const phone = document.getElementById("phone").value;
  const password = document.getElementById("password").value;

  try {
    const res = await fetch(API_URL + "/api/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone, password })
    });

    const data = await res.json();

    if (!data.success) {
      alert(data.error);
      hideAuthLoader();
      return;
    }

     // ğŸ”¥ QOâ€˜SHILGAN QISM (SHU YETISHMAYOTGAN EDI)
    if (data.user.role === "driver") {
      driverId = data.user.id;
      console.log("Driver ID:", driverId);
    }	
	  
    role = data.user.role;
    openRoleUI();

  } catch (e) {
    alert("Server bilan bogâ€˜lanib boâ€˜lmadi");
  }

  hideAuthLoader();

}

async function register() {
  if (!role) {
    alert("Avval rol tanlang");
    return;
  }

  showAuthLoader();

  const phone = document.getElementById("phone").value;
  const password = document.getElementById("password").value;

  try {
    const res = await fetch(API_URL + "/api/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone, password, role })
    });

    const data = await res.json();

    if (!data.success) {
      alert(data.error);
      hideAuthLoader();
      return;
    }

    alert("Roâ€˜yxatdan oâ€˜tildi!");
    openRoleUI();

  } catch (e) {
    alert("Server xatosi");
  }

  hideAuthLoader();
}




function openRoleUI() {
  document.getElementById("authUI").style.display = "none";

  if (role === "driver") {
    document.getElementById("driverUI").style.display = "block";
	watchOrdersForDriver(); // ğŸ”¥ DARROV BUYURTMA TEKSHIRADI
  }

  if (role === "passenger") {
    document.getElementById("passengerUI").style.display = "block";
    locatePassenger();       // ğŸ“ GPS
   
  }

  if (role === "admin") {
    document.getElementById("adminUI").style.display = "block";
  }
}



function backToRoles() {
  document.getElementById("authUI").style.display = "none";
  document.getElementById("roleSelect").style.display = "block";
}

let pMap;
let passengerPlacemark;

function initPassengerMap(lat, lng) {
  ymaps.ready(() => {
    pMap = new ymaps.Map("pMap", {
      center: [lat, lng],
      zoom: 16,
      controls: []
    });

    passengerPlacemark = new ymaps.Placemark(
      [lat, lng],
      { balloonContent: "ğŸ“ Siz shu yerdasiz" },
      {
        preset: "islands#blueDotIcon",
        draggable: false
      }
    );

    pMap.geoObjects.add(passengerPlacemark);

    // ğŸ”¥ XARITA SURILSA â€” MARKAZ YANGILANADI
   pMap.events.add("actionend", () => {
  if (locationLocked) return; // ğŸ”’ buyurtmadan keyin ishlamaydi

  const center = pMap.getCenter();

  passengerPlacemark.geometry.setCoordinates(center);

  window.manualPassengerLocation = {
    lat: center[0],
    lng: center[1]
  };

  useManualLocation = true;
});
  });
}


function locatePassenger() {
  if (useManualLocation) {
    console.log("ğŸ“Œ Qoâ€˜lda tanlangan joy ishlatilmoqda");
    return;
  }

  if (pMap) return;

  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    initPassengerMap(latitude, longitude);
  });
}


async function orderTaxi() {
  
  let lat, lng;

  if (useManualLocation && window.manualPassengerLocation) {
    lat = window.manualPassengerLocation.lat;
    lng = window.manualPassengerLocation.lng;
    console.log("ğŸ“¦ Buyurtma MANUAL joy bilan");
  } else {
    const pos = await new Promise((resolve, reject) =>
      navigator.geolocation.getCurrentPosition(resolve, reject)
    );
    lat = pos.coords.latitude;
    lng = pos.coords.longitude;
    console.log("ğŸ“¦ Buyurtma GPS joy bilan");
  }

  const res = await fetch(API_URL + "/api/order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      lat,
      lng,
      createdAt: Date.now()
    })
  });

  const data = await res.json();

  if (data.success) {
  locationLocked = true; // ğŸ”’ MUHIM

  document.getElementById("tripInfo").innerHTML =
    "<p>â³ Buyurtma yuborildi, haydovchi kutilmoqda...</p>";

  watchCurrentTrip();
  watchDriverOnPassengerMap();
}
}


let orderWatcher = null;

function watchOrdersForDriver() {
  if (orderWatcher) return;

  orderWatcher = setInterval(async () => {
    const res = await fetch(API_URL + "/api/order/current/" + driverId)
    const order = await res.json();

    const box = document.getElementById("orderBox");

    if (!order) {
      box.style.display = "none";
      return;
    }

    box.style.display = "block";
    document.getElementById("orderLocation").innerText =
      `Lat: ${order.lat.toFixed(5)}, Lng: ${order.lng.toFixed(5)}`;
	  if (lastPosition) {
  drawRoute(
    lastPosition.lat,
    lastPosition.lng,
    order.lat,
    order.lng
  );
}

  }, 2000);
}

function syncTrip() {
  fetch(API_URL + "/api/trip/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      status: "running",
      time: document.getElementById("time").innerText,
      distance: totalDistance.toFixed(2),
      price: document.getElementById("price").innerText
    })
  });
}

async function acceptOrder() {
  const res = await fetch(API_URL + "/api/order/accept", {
    method: "POST"
  });

  const data = await res.json();

  if (data.success) {
    alert("âœ… Buyurtma qabul qilindi");

    // âŒ QABUL QILISH TUGMASI YOâ€˜QOLSIN
    document.getElementById("acceptBtn").style.display = "none";

    // âœ… SAFAR PANELI OCHILSIN
    document.getElementById("tripPanel").style.display = "block";
  }
}

function hideBox() {
  document.querySelector(".box").classList.add("hidden");
  document.getElementById("miniHandle").style.display = "flex";

  // xarita buzilmasin
  setTimeout(() => {
    if (yMap) yMap.container.fitToViewport();
  }, 200);
}

function restoreBox() {
  document.querySelector(".box").classList.remove("hidden");
  document.getElementById("miniHandle").style.display = "none";

  setTimeout(() => {
    if (yMap) yMap.container.fitToViewport();
  }, 200);
}

function drawRoute(driverLat, driverLng, passengerLat, passengerLng) {
  if (!yMap) return;

  // ğŸ”¥ AGAR YOâ€˜L BOR BOâ€˜LSA â€” QAYTA CHIZMA
  if (routeDrawn) return;

  route = new ymaps.multiRouter.MultiRoute(
    {
      referencePoints: [
        [driverLat, driverLng],
        [passengerLat, passengerLng]
      ],
      params: {
        routingMode: "auto"
      }
    },
    {
      boundsAutoApply: true,
      routeActiveStrokeWidth: 5,
      routeActiveStrokeColor: "#00ff00"
    }
  );

  yMap.geoObjects.add(route);
  routeDrawn = true;
}

let driverMarker = null;
let passengerRoute = null;
function watchDriverOnPassengerMap() {
  if (passengerMapWatcher) return; // ğŸ”’ 2 marta ochilmasin

  passengerMapWatcher = setInterval(async () => {
    const res = await fetch(API_URL + "/api/driver/location");
    const driver = await res.json();
    if (!driver || !pMap) return;

    const driverCoords = [driver.lat, driver.lng];

    // ğŸš• MARKER
    if (!driverMarker) {
      driverMarker = new ymaps.Placemark(
        driverCoords,
        { balloonContent: "ğŸš• Haydovchi" },
        { preset: "islands#redTaxiIcon" }
      );
      pMap.geoObjects.add(driverMarker);
    } else {
      driverMarker.geometry.setCoordinates(driverCoords);
    }

    // ğŸ›£ YOâ€˜L (1 MARTA)
    if (!passengerRoute && window.manualPassengerLocation) {
      passengerRoute = new ymaps.multiRouter.MultiRoute(
        {
          referencePoints: [
            driverCoords,
            [window.manualPassengerLocation.lat, window.manualPassengerLocation.lng]
          ]
        },
        {
          routeActiveStrokeWidth: 5,
          routeActiveStrokeColor: "#00ff00"
        }
      );
      pMap.geoObjects.add(passengerRoute);
    }
  }, 2000);
}


function clearPassengerMap() {
  // ğŸ›‘ kuzatuvni toâ€˜xtatish
  if (passengerMapWatcher) {
    clearInterval(passengerMapWatcher);
    passengerMapWatcher = null;
  }

  // ğŸ›£ marshrut
  if (passengerRoute && pMap) {
    pMap.geoObjects.remove(passengerRoute);
    passengerRoute = null;
  }

  // ğŸš• haydovchi belgisi
  if (driverMarker && pMap) {
    pMap.geoObjects.remove(driverMarker);
    driverMarker = null;
  }

  // ğŸ”„ GPS GA QAYTISH
  locationLocked = false; // ğŸ”“ yana joy tanlash mumkin
  useManualLocation = false;
  window.manualPassengerLocation = null;

  movePassengerToGPS(); // ğŸ”¥ MANA SHU YETISHMAYOTGAN QATOR

  console.log("ğŸ§¹ Safar yakunlandi â†’ GPS qayta ishga tushdi");
}


function movePassengerToGPS() {
  if (!navigator.geolocation || !pMap || !passengerPlacemark) return;

  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;

    const coords = [latitude, longitude];

    // ğŸ“ marker koâ€˜chadi
    passengerPlacemark.geometry.setCoordinates(coords);

    // ğŸ—º xarita markazlanadi
    pMap.setCenter(coords, 16, { duration: 300 });

    console.log("ğŸ“ Yoâ€˜lovchi GPS joyiga qaytdi");
  });
}

function showAuthLoader() {
  document.getElementById("authLoader").style.display = "block";
  document.querySelectorAll("#authUI button").forEach(b => {
    b.classList.add("loading");
  });
}

function hideAuthLoader() {
  document.getElementById("authLoader").style.display = "none";
  document.querySelectorAll("#authUI button").forEach(b => {
    b.classList.remove("loading");
  });
}





//   npx http-server .                         bu front server uchun powershel kodi faqat lakal
//   npx http-server . -a 0.0.0.0 -p 8080      bu lakal ham tashqi qurulmalarga pwsh kodi 
</script>

<script>

let tripWatchInterval = null;

function watchCurrentTrip() {
  if (tripWatchInterval) return;

  tripWatchInterval = setInterval(async () => {
   const orderRes = await fetch(
  API_URL + "/api/order/passenger/current"
);
    const tripRes  = await fetch(API_URL + "/api/trip/current");

    const order = await orderRes.json();
    const trip  = await tripRes.json();

    const el = document.getElementById("tripInfo");

    // â³ buyurtma yuborilgan
    if (order && order.status === "waiting") {
      el.innerHTML = "<p>â³ Haydovchi javobi kutilmoqda...</p>";
      return;
    }

    // ğŸš• haydovchi yoâ€˜lda
    if (order && order.status === "accepted" && !trip) {
      el.innerHTML = "<p>ğŸš• Haydovchi yoâ€˜lda</p>";
      return;
    }

    // ğŸš• safar davom etmoqda
    if (trip && trip.status === "running") {
      el.innerHTML = `
        <p>ğŸš• Safar davom etmoqda</p>
        <p>â± ${trip.time}</p>
        <p>ğŸ“ ${trip.distance} km</p>
        <p>ğŸ’° ${trip.price} soâ€˜m</p>
      `;
      return;
    }

   // ğŸ safar tugadi â†’ avtomatik tozalash
if (!trip && !order) {
  el.innerHTML = "<p>ğŸ Safar yakunlandi</p>";

  // ğŸ”¥ XARITANI AVTOMATIK TOZALASH
  clearPassengerMap();

  clearInterval(tripWatchInterval);
  tripWatchInterval = null;
  return;
}


    el.innerHTML = "<p>ğŸš• Hozircha faol safar yoâ€˜q</p>";
  }, 2000);
}



</script>
</body>

</html>







